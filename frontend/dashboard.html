<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KubeSMO - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .card h2.ai-title {
            border-bottom-color: #11998e;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            background: #5a6fd6;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-predict {
            background: #667eea;
        }

        .btn-predict:hover {
            background: #5a6fd6;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-ai-predict {
            background: #667eea;
        }

        .btn-ai-predict:hover {
            background: #5a6fd6;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-submit {
            width: auto;
            margin-top: 28px;
        }

        .chart-container {
            position: relative;
            height: 280px;
            margin-bottom: 20px;
        }

        .prediction-result {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .prediction-result.show {
            display: block;
        }

        .prediction-result.ai-result {
            background: #e6fff2;
            border-color: #11998e;
        }

        .prediction-result h3 {
            color: #0066cc;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .prediction-result.ai-result h3 {
            color: #11998e;
        }

        .prediction-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .prediction-row {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .prediction-item {
            flex: 1;
        }

        .info-badge {
            display: inline-block;
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: 500;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .spinner.ai-spinner {
            border-top-color: #11998e;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* ===== Responsive: 2컬럼 유지, 전체 비례 축소 ===== */
        @media (max-width: 1400px) {
            .main-container {
                max-width: 100%;
            }

            .header h1 {
                font-size: clamp(18px, 2.5vw, 36px);
            }

            .header p {
                font-size: clamp(11px, 1.2vw, 16px);
            }

            .grid {
                gap: clamp(8px, 1.4vw, 20px);
            }

            .card {
                padding: clamp(10px, 2vw, 30px);
            }

            .card h2 {
                font-size: clamp(13px, 1.5vw, 22px);
                margin-bottom: clamp(8px, 1.4vw, 20px);
                padding-bottom: clamp(5px, 0.7vw, 10px);
            }

            .form-row {
                gap: clamp(6px, 1.4vw, 20px);
            }

            label {
                font-size: clamp(10px, 1vw, 14px);
                margin-bottom: clamp(3px, 0.5vw, 8px);
            }

            select, input[type="number"], input[type="text"] {
                padding: clamp(6px, 0.8vw, 12px) clamp(8px, 1vw, 15px);
                font-size: clamp(11px, 1vw, 15px);
            }

            .btn {
                padding: clamp(8px, 1vw, 15px) clamp(14px, 2vw, 30px);
                font-size: clamp(11px, 1.1vw, 16px);
            }

            .chart-container {
                height: clamp(150px, 20vw, 280px);
            }

            .prediction-value {
                font-size: clamp(14px, 1.7vw, 24px);
            }

            .prediction-row {
                gap: clamp(10px, 2vw, 30px);
            }

            .info-badge {
                font-size: clamp(9px, 0.8vw, 12px);
                padding: 2px 6px;
            }

            body {
                padding: clamp(8px, 1.4vw, 20px);
            }
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .inline-result {
            display: inline-block;
            margin-left: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            vertical-align: middle;
        }

        .time-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .time-selector select {
            width: auto;
            min-width: 180px;
        }

        .time-selector label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .scale-out-warning {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
            border: 2px solid #f5576c;
        }

        .scale-out-ok {
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
            border: 2px solid #11998e;
        }

        .job-result-bar {
            display: none;
            margin-top: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .job-result-bar.success {
            display: block;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .job-result-bar.error {
            display: block;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>KubeSMO Dashboard</h1>
            <p>AI Workload Management & Throughput Prediction</p>
        </div>

        <!-- Top Row: AI Job Submission (Full Width) -->
        <div class="grid">
            <div class="card full-width">
                <h2>AI Job Submission</h2>
                <form id="jobForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modelName">
                                Model <span class="info-badge">Required</span>
                            </label>
                            <select id="modelName" name="name" required>
                                <option value="">-- Select Model --</option>
                                <option value="llama 1B">Llama 1B</option>
                                <option value="qwen 8B">Qwen 8B</option>
                                <option value="qwen 14B">Qwen 14B</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="jobType">Job Type</label>
                            <select id="jobType" name="job_type" required>
                                <option value="Spot" selected>Spot</option>
                                <option value="HP">HP</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="duration">Duration (min)</label>
                            <input type="number" id="duration" name="duration" value="10" min="1" step="0.1" required />
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-submit" id="submitBtn">Submit Job</button>
                        </div>
                    </div>
                    <div id="jobResult" class="job-result-bar" style="display:none !important;"></div>
                </form>

                <div class="loading" id="jobLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Submitting...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Row: RAN Prediction (Left) + AI Prediction (Right) -->
        <div class="grid">
            <!-- RAN Throughput Prediction -->
            <div class="card">
                <h2>RAN Throughput Prediction</h2>

                <div class="chart-container">
                    <canvas id="ranChart"></canvas>
                </div>

                <button class="btn btn-predict" id="ranPredictBtn" onclick="predictRanThroughput()">
                    Predict RAN Throughput (15 min)
                </button>

                <div class="loading" id="ranPredictLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Predicting...</p>
                </div>

                <div class="prediction-result" id="ranPredictionResult">
                    <h3>Prediction Result (15 min later)</h3>
                    <div class="prediction-row">
                        <div class="prediction-item">
                            <strong>Predicted Throughput:</strong>
                            <div class="prediction-value" id="ranPredictedValue">-</div>
                        </div>
                        <div class="prediction-item">
                            <strong>MIG Scale Decision:</strong>
                            <div class="prediction-value" id="ranMigDecision" style="color: #667eea;">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="scaleUp()" id="scaleUpBtn">
                            Scale Up RAN
                        </button>
                    </div>
                </div>

                <div class="loading" id="scaleLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Scaling up...</p>
                </div>

                <div class="result" id="scaleResult" style="display:none !important;"></div>
            </div>

            <!-- AI Throughput Prediction -->
            <div class="card">
                <h2 class="ai-title">AI Throughput Prediction</h2>

                <div class="chart-container">
                    <canvas id="aiChart"></canvas>
                </div>


                <button class="btn btn-ai-predict" id="aiPredictBtn" onclick="predictAiThroughput()">
                    Predict AI Throughput (5 min)
                </button>

                <div class="loading" id="aiPredictLoading">
                    <div class="spinner ai-spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Predicting...</p>
                </div>

                <div class="prediction-result ai-result" id="aiPredictionResult">
                    <h3>Prediction Result (5 min later)</h3>
                    <div class="prediction-row">
                        <div class="prediction-item">
                            <strong>Predicted Throughput:</strong>
                            <div class="prediction-value" id="aiUpperBoundValue" style="color: #764ba2;">-</div>
                        </div>
                        <div class="prediction-item">
                            <strong>MIG Scale Decision:</strong>
                            <div class="prediction-value" id="aiMigDecision" style="color: #667eea;">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;" id="aiScaleOutBtnContainer" style="display: none;">
                        <button class="btn" onclick="scaleOutAi()" id="scaleOutAiBtn">
                            Scale Out AI
                        </button>
                    </div>
                </div>

                <div class="loading" id="aiScaleLoading">
                    <div class="spinner ai-spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Scaling out...</p>
                </div>

                <div class="result" id="aiScaleResult" style="display:none !important;"></div>
            </div>
        </div>
    </div>

    <script>
        // API_BASE_URL: 현재 호스트 기반으로 설정 (같은 서버에서 실행 시)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8001'
            : `http://${window.location.hostname}:8001`;

        let ranChart;
        let aiChart;
        let ranCellData = null;
        let aiData = [];
        let currentAiIndex = 9; // Index of "Current" point (10:05), predict will show 10:10

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRanCellData();
            loadAiData();
            setupJobForm();
        });

        // ==================== RAN Prediction ====================

        let ranData = [];
        let currentRanIndex = 0;

        // Scale-out threshold for RAN (normalized throughput)
        // 700 Mbps / 1450 = 0.483
        const RAN_SCALE_OUT_THRESHOLD = 0.483;

        // Embedded RAN data (09:40 ~ 10:25 range) from RealData_inference_with_uncertainty_group15.csv
        // 15분 예측을 위해 10:25까지 포함
        function getEmbeddedRanData() {
            return [
                { timestamp: "2023-08-17 09:40", actual: 0.326, predicted: 0.323, upper_bound_95: 0.335 },
                { timestamp: "2023-08-17 09:45", actual: 0.346, predicted: 0.333, upper_bound_95: 0.337 },
                { timestamp: "2023-08-17 09:50", actual: 0.385, predicted: 0.414, upper_bound_95: 0.402 },
                { timestamp: "2023-08-17 09:55", actual: 0.334, predicted: 0.341, upper_bound_95: 0.373 },
                { timestamp: "2023-08-17 10:00", actual: 0.321, predicted: 0.326, upper_bound_95: 0.348 },
                { timestamp: "2023-08-17 10:05", actual: 0.331, predicted: 0.322, upper_bound_95: 0.339 },
                { timestamp: "2023-08-17 10:10", actual: 0.307, predicted: 0.302, upper_bound_95: 0.300 },
                // 15분 예측용 (10:10 기준 -> 10:25 예측)
                { timestamp: "2023-08-17 10:15", actual: 0.307, predicted: 0.296, upper_bound_95: 0.298 },
                { timestamp: "2023-08-17 10:20", actual: 0.321, predicted: 0.321, upper_bound_95: 0.333 },
                { timestamp: "2023-08-17 10:25", actual: 1.000, predicted: 0.510, upper_bound_95: 0.550 }
            ];
        }

        // Load RAN cell data and draw chart
        async function loadRanCellData() {
            ranData = getEmbeddedRanData();
            currentRanIndex = 6; // Start at 10:10
            ranCellData = { future: { features: [] } }; // Placeholder for prediction
            drawRanChart();
        }

        // Draw RAN chart (Actual + Predicted dotted + Threshold)
        function drawRanChart() {
            const ctx = document.getElementById('ranChart').getContext('2d');

            const labels = [];
            const actualValues = [];
            const predictedValues = [];

            // Show data points as history + current
            const startIdx = Math.max(0, currentRanIndex - 6);
            for (let i = startIdx; i <= currentRanIndex; i++) {
                const timeStr = ranData[i].timestamp.split(' ')[1];
                labels.push(i === currentRanIndex ? 'Current' : timeStr);
                actualValues.push(ranData[i].actual * 1450); // Convert to Mbps
                predictedValues.push(ranData[i].predicted * 1450); // y_pred for RAN
            }

            // Threshold line data
            const thresholdValues = actualValues.map(() => RAN_SCALE_OUT_THRESHOLD * 1450);

            if (ranChart) {
                ranChart.destroy();
            }

            ranChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual Throughput',
                            data: actualValues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            fill: false,
                            pointBackgroundColor: function(context) {
                                const index = context.dataIndex;
                                return index === actualValues.length - 1 ? '#f5576c' : '#667eea';
                            }
                        },
                        {
                            label: 'Predicted Throughput',
                            data: predictedValues,
                            borderColor: '#764ba2',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#764ba2',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: `Threshold (${(RAN_SCALE_OUT_THRESHOLD * 1450).toFixed(0)} Mbps)`,
                            data: thresholdValues,
                            borderColor: '#f5576c',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 400,
                            max: 800,
                            title: { display: true, text: 'Throughput (Mbps)' }
                        },
                        x: {
                            title: { display: true, text: 'Time' }
                        }
                    }
                }
            });
        }

        // Predict RAN throughput (15 min later = 3 intervals of 5 min)
        async function predictRanThroughput() {
            const predictBtn = document.getElementById('ranPredictBtn');
            const loading = document.getElementById('ranPredictLoading');
            const resultDiv = document.getElementById('ranPredictionResult');

            // 15분 뒤 = 3개 인덱스 뒤
            const predictionIdx = currentRanIndex + 3;
            if (predictionIdx >= ranData.length) {
                alert('No future data available for 15 min prediction');
                return;
            }

            predictBtn.disabled = true;
            loading.style.display = 'block';
            resultDiv.classList.remove('show');

            // Simulate prediction delay
            await new Promise(resolve => setTimeout(resolve, 500));

            try {
                // Get 15 min later prediction - RAN uses y_pred
                const predictedValue = ranData[predictionIdx].predicted;
                const predictedMbps = predictedValue * 1450;

                // Calculate MIG cells needed
                const cellsNeeded = Math.ceil(predictedMbps / 500);

                document.getElementById('ranPredictedValue').textContent = predictedMbps.toFixed(2) + ' Mbps';
                document.getElementById('ranMigDecision').textContent = cellsNeeded + ' cells';

                resultDiv.classList.add('show');

                // Add prediction point to chart (extend dotted line only)
                ranChart.data.labels.push('+15min');

                // Actual line - null로 끊기 (미래 실제값 안 그림)
                ranChart.data.datasets[0].data.push(null);

                // Predicted line - 예측값으로 연장
                ranChart.data.datasets[1].data.push(predictedMbps);

                // Threshold line 유지
                ranChart.data.datasets[2].data.push(RAN_SCALE_OUT_THRESHOLD * 1450);

                ranChart.update();

            } catch (error) {
                alert('Prediction error: ' + error.message);
            } finally {
                predictBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // Scale up RAN (HP-scale-up job submission)
        async function scaleUp() {
            const scaleUpBtn = document.getElementById('scaleUpBtn');
            const loading = document.getElementById('scaleLoading');
            const result = document.getElementById('scaleResult');

            scaleUpBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';

            const timestamp = Date.now();
            const jobId = `ran-mig-${timestamp}`;

            try {
                const response = await fetch(`${API_BASE_URL}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "job_id": jobId,
                        "name": "aerial-l1-1",
                        "job_type": "migration",
                        "workload_type": "RAN",
                        "req": 4,
                        "duration": 120,
                        "target_job_id": "ran-1",
                        "launch_pattern": "F08 2C 59",
                        "cell_group_num": 2
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'submitted') {
                    result.className = 'result success';
                    result.textContent = `Scale up submitted! Job ID: ${data.job_id}`;
                    result.style.display = 'block';
                } else {
                    result.className = 'result error';
                    result.textContent = 'Scale up failed: ' + (data.message || JSON.stringify(data));
                    result.style.display = 'block';
                }
            } catch (error) {
                // silent
            } finally {
                scaleUpBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // ==================== AI Prediction ====================

        // Load AI data (use embedded data for demo)
        async function loadAiData() {
            // Use embedded sample data with uncertainty (09:40 ~ 10:10 range)
            aiData = getEmbeddedAiData();
            currentAiIndex = aiData.length - 2; // Start at 10:05 (second to last)
            drawAiChart();
        }

        // Embedded AI data (sample from CSV with uncertainty) - 09:40 ~ 10:10 range
        function getEmbeddedAiData() {
            return [
                { timestamp: "2024-05-18 09:40", actual: 2.213, predicted: 3.396, upper_bound_95: 4.510 },
                { timestamp: "2024-05-18 09:45", actual: 2.332, predicted: 2.954, upper_bound_95: 4.015 },
                { timestamp: "2024-05-18 09:50", actual: 2.891, predicted: 2.790, upper_bound_95: 3.798 },
                { timestamp: "2024-05-18 09:55", actual: 3.726, predicted: 3.015, upper_bound_95: 4.101 },
                { timestamp: "2024-05-18 10:00", actual: 3.429, predicted: 3.443, upper_bound_95: 4.449 },
                { timestamp: "2024-05-18 10:05", actual: 4.381, predicted: 3.490, upper_bound_95: 4.373 },
                { timestamp: "2024-05-18 10:10", actual: 4.953, predicted: 4.067, upper_bound_95: 5.288 }
            ];
        }

        // Scale-out threshold (capacity limit per pod)
        const AI_SCALE_OUT_THRESHOLD = 5.0;

        // Draw AI chart (Actual + Predicted dotted + Threshold)
        function drawAiChart() {
            const ctx = document.getElementById('aiChart').getContext('2d');

            const labels = [];
            const actualValues = [];
            const predictedValues = [];

            // Show last 6 points as history + current
            const startIdx = Math.max(0, currentAiIndex - 5);
            for (let i = startIdx; i <= currentAiIndex; i++) {
                const timeStr = aiData[i].timestamp.split(' ')[1]; // Get time part only
                labels.push(i === currentAiIndex ? 'Current' : timeStr);
                actualValues.push(aiData[i].actual);
                predictedValues.push(aiData[i].upper_bound_95); // upper_bound_95 for AI
            }

            // Threshold line data
            const thresholdValues = actualValues.map(() => AI_SCALE_OUT_THRESHOLD);

            if (aiChart) {
                aiChart.destroy();
            }

            aiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual Throughput',
                            data: actualValues,
                            borderColor: '#11998e',
                            backgroundColor: 'rgba(17, 153, 142, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            fill: false,
                            pointBackgroundColor: function(context) {
                                const index = context.dataIndex;
                                return index === actualValues.length - 1 ? '#f5576c' : '#11998e';
                            }
                        },
                        {
                            label: 'Predicted Throughput',
                            data: predictedValues,
                            borderColor: '#764ba2',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#764ba2',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: `Threshold (${AI_SCALE_OUT_THRESHOLD} req/sec)`,
                            data: thresholdValues,
                            borderColor: '#f5576c',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 7,
                            title: { display: true, text: 'Throughput (req/sec)' }
                        },
                        x: {
                            title: { display: true, text: 'Time' }
                        }
                    }
                }
            });

        }

        // Predict AI throughput with uncertainty-aware scaling decision (5 min later)
        async function predictAiThroughput() {
            const predictBtn = document.getElementById('aiPredictBtn');
            const loading = document.getElementById('aiPredictLoading');
            const resultDiv = document.getElementById('aiPredictionResult');

            if (currentAiIndex >= aiData.length - 1) {
                alert('No future data available for prediction');
                return;
            }

            predictBtn.disabled = true;
            loading.style.display = 'block';
            resultDiv.classList.remove('show');

            // Simulate prediction delay
            await new Promise(resolve => setTimeout(resolve, 500));

            try {
                // Get next point's prediction (5 min later) - AI uses upper_bound_95
                const nextIdx = currentAiIndex + 1;
                const upperBoundValue = aiData[nextIdx].upper_bound_95;

                // Calculate MIG pods needed based on upper_bound_95
                const podsNeeded = Math.ceil(upperBoundValue / 5);
                const currentPods = 1;
                const needsScaleOut = podsNeeded > currentPods;

                document.getElementById('aiUpperBoundValue').textContent = upperBoundValue.toFixed(2) + ' req/sec';
                document.getElementById('aiMigDecision').textContent = podsNeeded + ' pods';

                // Show/hide scale-out button
                const scaleOutBtnContainer = document.getElementById('aiScaleOutBtnContainer');
                if (scaleOutBtnContainer) {
                    scaleOutBtnContainer.style.display = needsScaleOut ? 'block' : 'none';
                }

                resultDiv.classList.add('show');

                // Add prediction point to chart (extend dotted line only)
                aiChart.data.labels.push('+5min');

                // Actual line - null로 끊기 (미래 실제값 안 그림)
                aiChart.data.datasets[0].data.push(null);

                // Predicted line - 예측값으로 연장
                aiChart.data.datasets[1].data.push(upperBoundValue);

                // Threshold line 유지
                aiChart.data.datasets[2].data.push(AI_SCALE_OUT_THRESHOLD);

                aiChart.update();

            } catch (error) {
                alert('Prediction error: ' + error.message);
            } finally {
                predictBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // Scale out AI workload
        async function scaleOutAi() {
            const scaleOutBtn = document.getElementById('scaleOutAiBtn');
            const loading = document.getElementById('aiScaleLoading');
            const result = document.getElementById('aiScaleResult');

            scaleOutBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';

            const timestamp = Date.now();
            const targetJobId = "ai-online-1";
            const jobId = `${targetJobId}-scaleout-${timestamp}`;

            try {
                const response = await fetch(`${API_BASE_URL}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "job_id": jobId,
                        "name": "AI-Workload-ScaleOut",
                        "job_type": "scale-out",
                        "workload_type": "AI",
                        "req": 3,
                        "duration": 30,
                        "target_job_id": targetJobId
                    })
                });

                const data = await response.json();

                if (response.ok && data.status === 'submitted') {
                    result.className = 'result success';
                    result.textContent = `Scale out submitted! Job ID: ${data.job_id}`;
                    result.style.display = 'block';
                } else {
                    result.className = 'result error';
                    result.textContent = 'Scale out failed: ' + (data.message || JSON.stringify(data));
                    result.style.display = 'block';
                }
            } catch (error) {
                // silent
            } finally {
                scaleOutBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // ==================== Job Submission ====================

        // Model name to MIG req mapping
        function getReqFromModel(modelName) {
            const reqMap = {
                'llama 1B': 1,
                'qwen 8B': 2,
                'qwen 14B': 3
            };
            return reqMap[modelName] || 1;
        }

        // Generate unique job ID
        function generateJobId(jobType) {
            const timestamp = Date.now();
            const prefix = jobType.toLowerCase();
            return `${prefix}-${timestamp}`;
        }

        function setupJobForm() {
            document.getElementById('jobForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const loading = document.getElementById('jobLoading');
                const result = document.getElementById('jobResult');

                submitBtn.disabled = true;
                loading.style.display = 'block';
                result.style.display = 'none';
                result.className = 'job-result-bar';

                const modelName = document.getElementById('modelName').value;
                const jobType = document.getElementById('jobType').value;
                const duration = parseFloat(document.getElementById('duration').value);
                const timestamp = Date.now();
                const isSpot = jobType === 'Spot';
                const jobId = isSpot ? `spot-ai-${timestamp}` : `hp-${timestamp}`;

                const formData = {
                    job_id: jobId,
                    name: isSpot ? `workload-spot-${timestamp}` : modelName,
                    job_type: "deploy",
                    workload_type: "AI",
                    req: 4,
                    duration: duration
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'submitted') {
                        result.className = 'job-result-bar success';
                        result.textContent = `Job submitted! ID: ${data.job_id}`;
                        result.style.display = 'block';
                        document.getElementById('jobForm').reset();
                    } else {
                        result.className = 'job-result-bar error';
                        result.textContent = 'Failed: ' + (data.message || JSON.stringify(data));
                        result.style.display = 'block';
                    }
                } catch (error) {
                    // silent
                } finally {
                    submitBtn.disabled = false;
                    loading.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
